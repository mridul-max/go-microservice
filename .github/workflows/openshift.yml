name: Deploy Go Microservice to OpenShift

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # OpenShift and Docker Registry Secrets
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  OPENSHIFT_NAMESPACE: "kilo-dev"  # Replace with your namespace
  APP_NAME: "go-drinkapp"  # Replace with your app name
  APP_PORT: "8082"  # Replace with your app's listening port
  IMAGE_REGISTRY: "docker.io"  # Docker Hub or other registry
  IMAGE_REGISTRY_USER: "mridul017"
  IMAGE_REGISTRY_PASSWORD: ${{ secrets.IMAGE_REGISTRY_PASSWORD }}
  IMAGE_TAGS: "latest-${{ github.sha }}"  # Dynamic tagging for better versioning

jobs:
  build-and-deploy:
    name: Build and Deploy to OpenShift
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Check out the repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Step 3: Build Docker Image
      - name: Build Docker Image
        run: |
          IMAGE_FULL_NAME=${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REGISTRY_USER }}/${{ env.APP_NAME }}:${{ env.IMAGE_TAGS }}
          docker build -t $IMAGE_FULL_NAME -f ./Dockerfile .
          echo "IMAGE_FULL_NAME=$IMAGE_FULL_NAME" >> $GITHUB_ENV

      # Step 4: Docker Login
      - name: Docker Login
        run: |
          echo ${{ secrets.IMAGE_REGISTRY_PASSWORD }} | docker login ${{ env.IMAGE_REGISTRY }} -u ${{ env.IMAGE_REGISTRY_USER }} --password-stdin

      # Step 5: Push Docker Image to Registry
      - name: Push Docker Image to Registry
        run: |
          docker push ${{ env.IMAGE_FULL_NAME }}

      # Step 6: Install OpenShift CLI
      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: 4.6.0  # Update version if needed

      # Step 7: Log in to OpenShift
      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ env.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE }}

      # Step 8: Delete Existing Resources (if any)
      - name: Delete Existing Resources
        run: |
          oc delete all --selector app=${{ env.APP_NAME }} --ignore-not-found

      # Step 9: Deploy and Expose OpenShift App
      - name: Deploy and Expose OpenShift App
        run: |
          echo "Deploying image: ${{ env.IMAGE_FULL_NAME }}"
          oc new-app ${{ env.IMAGE_FULL_NAME }} --name=${{ env.APP_NAME }} -n ${{ env.OPENSHIFT_NAMESPACE }} --port=${{ env.APP_PORT }}

      # Step 10: Inject Environment Variables
      - name: Inject Environment Variables
        run: |
          oc set env deployment/${{ env.APP_NAME }} \
            DBURI=${{ secrets.DBURI }} \
            DBKEY=${{ secrets.DBKEY }} \
            DBNAME=${{ secrets.DBNAME }}

      # Step 11: Wait for Deployment Rollout
      - name: Wait for Deployment Rollout
        run: |
          oc rollout status deployment/${{ env.APP_NAME }} --watch

      # Step 12: Print Application URL
      - name: Print Application URL
        run: |
          ROUTE=$(oc get route ${{ env.APP_NAME }} -o jsonpath='{.spec.host}')
          echo "========================="
          echo "Your app is available at: http://$ROUTE"
          echo "========================="
